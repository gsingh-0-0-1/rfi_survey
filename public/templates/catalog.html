<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ATA RFI Catalog</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300&display=swap" rel="stylesheet">
    <style>
        body{
            font-family: Source Code Pro;
            background-color: #123;
        }
        
        .forminput{
            font-family: Source Code Pro;
            background-color: #345;
            border: none;
            color: white;
            padding: 1vh 1vh;
        }

        .forminput:focus{
            outline: none
        }

        .formbutton{
            font-family: Source Code Pro;
            background-color: #666;
            border: none;
            color: #eee;
            padding: 1vh 1vh;
        }

        #queryresults{
            position: relative;
            margin-top: 5%;
            left: 2%;
            width: 96%;
            color: white;
            border: 0.1vh solid #888;
            table-layout: fixed;
        }

        a{
            color: #aaf
        }

        #queryresults{
            border-collapse: collapse;
            font-size: calc(1.1vh + 0.5vw);
        }

        #queryresults tr:nth-child(5n + 1){
            border-bottom: 0.1vh solid #888;
        }

        #queryresults tr td:first-child{
            padding-right: 2vh
        }

        #queryresults td:nth-child(10n + 1){
            text-align: right;
            width: 4%;
        }

        #queryresults td:nth-child(10n + 2){
            color: #0ff;
            width: 16%;
        }

        #queryresults td:nth-child(10n + 3){
            color: #09e;
            width: 7%;
        }

        #queryresults td:nth-child(10n + 4){
            color: #09e;
            width: 7%;
        }

        #queryresults td:nth-child(10n + 5){
            color: #d55;
            width: 13%;
        }

        #queryresults td:nth-child(10n + 6){
            color: #f22;
            width: 11%;
        }

        #queryresults td:nth-child(10n + 7){
            color: #ff2;
            width: 6%;
        }

        #queryresults td:nth-child(10n + 8){
            color: #888;
            width: 5%;
        }

        #queryresults td:nth-child(10n + 9){
            color #666;
            width: 17%;
        }

        #queryresults td:nth-child(10n){
            color: #aaf;
            width: 13%;
        }

        #formdetails{
            position: relative;
            left: 50%;
            transform: translate(-50%, 0%);
            color: white;
            table-layout: fixed;
            width: 55%;
        }

        #formdetails td{
            padding-top: 1vh;
            padding-bottom: 1vh;
        }

        #formdetails td:nth-child(2n){
            padding-left: 1vh;
        }

        #formdetails td:nth-child(2n + 1){
            padding-right: 1vh;
            text-align: right;
        }

        /*Checkboxes styles*/
        input[type="checkbox"] { display: none; }

        input[type="checkbox"] + label {
            display: block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 20px;
            color: #ddd;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        input[type="checkbox"] + label:last-child { margin-bottom: 0; }

        input[type="checkbox"] + label:before {
            content: '';
            display: block;
            width: 20px;
            height: 20px;
            border: 1px solid #6cc0e5;
            position: absolute;
            left: 0;
            top: 0;
            opacity: .6;
            -webkit-transition: all .12s, border-color .08s;
            transition: all .12s, border-color .08s;
        }

        input[type="checkbox"]:checked + label:before {
            width: 10px;
            top: -5px;
            left: 5px;
            border-radius: 0;
            opacity: 1;
            border-top-color: transparent;
            border-left-color: transparent;
            -webkit-transform: rotate(45deg);
			transform: rotate(45deg);
		}
    </style>
</head>
<body>
    <table id="formdetails">
        <tbody>
            <tr>
                <td>
                    Center Frequency (MHz):
                </td>
                <td>
                    <input class="forminput" type="text" id="cfreq">
                </td>
            </tr>
            <tr>
                <td>
                    Frequency Range (MHz):
                </td>
                <td>
                    <input class="forminput" type="text" id="frange" value="25">
                </td>
            </tr>
            <tr>
                <td>
                    Azimuth:
                </td>
                <td>
                    <input class="forminput" type="text" id="az">
                </td>
            </tr>
            <tr>
                <td>
                    Minimum Effective Azimuth Width:
                </td>
                <td>
                    <input class="forminput" type="text" id="azwidth" value="0.5">
                </td>
            </tr>
            <tr>
                <td>
                    Azimuth Half-Range:
                </td>
                <td>
                    <input class="forminput" type="text" id="azrange" value="1">
                </td>
            </tr>
            <tr>
                <td>
                    Elevation:
                </td>
                <td>
                    <input class="forminput" type="text" id="el">
                </td>
            </tr>
            <tr>
                <td>
                    Elevation Range:
                </td>
                <td>
                    <input class="forminput" type="text" id="elrange" value="2.5">
                </td>
            </tr>
            <tr>
                <td>
                    Start Date:
                </td>
                <td>
                    <input class="forminput" type="text" id="startdate" placeholder="YYYY-MM-DD">
                </td>
            </tr>
            <tr>
                <td>
                    End Date:
                </td>
                <td>
                    <input class="forminput" type="text" id="enddate" placeholder="YYYY-MM-DD">
                </td>
            </tr>
            <tr>
                <td>
                    Max # of matches:
                </td>
                <td>
                    <input class="forminput" type="text" id="maxhits" value="100">
                </td>
            </tr>
            <tr>
                <td>
                    Limit to Named Sources
                </td>
                <td>
                    <input type="checkbox" id="sourcesearch">
                    <label for="sourcesearch" style="color: #FFFFFF; display: inline"></label>
                </td>
            </tr>
            <tr>
                <td>
                    <button class="formbutton" onclick="javascript:submitQuery()">
                        Submit Query 
                    </button>
                </td>
                <td>
                    <button class="formbutton" onclick="javascript:searchFullSky()">
                        Search Entire Sky @ CFREQ
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

    <table id="queryresults">
        <tbody>
            <tr style='background-color: #123'>
                <td>RANK</td>
                <td>OBS</td>
                <td>AZ</td>
                <td>ELEV</td>
                <td>POWER SPIKE (dB)</td>
                <td>EFF. AZ. WIDTH</td>
                <td>CFREQ</td>
                <td>ANTLO</td>
                <td>SOURCE GUESS</td>
                <td>URL</td>
            </tr>
        </tbody>
    </table>
</body>
<script>
    var tbody = queryresults.children[0];

    var COLORS = {0 : "#001020",
        1 : "#081828",
        2 : "#102030",
        3 : "#182838",
        4 : "#203040",
        5 : "#283848",
        6 : "#304050",
        7 : "#384858"
    }

    function searchFullSky(){
        //frange.value = 336
        az.value = 180
        azrange.value = 180
        el.value = 45
        elrange.value = 45
        submitQuery()
    }


    function getRowColor(c){
        if (c == "#012"){
            return "#152535"
        }
        return "#012"
    }

    function submitQuery(){
        
        var ROWCOLOR = "#012"

        var query_items = []

        //parse the CFREQ first
        var item = "cfreq,"
        if (cfreq.value.replaceAll(" ", "") == ""){
            item = item + "IS NOT,NULL"
        }
        else{
            var flo = cfreq.value * 1 - frange.value * 1
            var fhi = cfreq.value * 1 + frange.value * 1
            item = item + ">," + flo + ":cfreq,<," + fhi
        }

        query_items.push(item)

        //now the elevation
        var item = "elev,"
        if (el.value.replaceAll(" ", "") == ""){
            item = item + "IS NOT,NULL"
        }
        else{
            var elo = el.value * 1 - elrange.value * 1
            var ehi = el.value * 1 + elrange.value * 1
            item = item + ">," + elo + ":elev,<," + ehi
        }

        query_items.push(item)

        //now the azimuth
        var item = "(end_az+start_az)<div>2,"
        if (azrange.value.replaceAll(" ", "") == ""){
            azrange.value = 2.5
        }

        if (az.value.replaceAll(" ", "") == ""){
            item = item + "IS NOT,NULL"
        }
        else{
            var alo = az.value * 1 - azrange.value * 1
            var ahi = az.value * 1 + azrange.value * 1
            item = item + ">," + alo + ":(end_az+start_az)<div>2,<," + ahi
        }

        query_items.push(item)

        if (startdate.value.replaceAll(" ", "") != ""){
            query_items.push("replace(replace(obs<cm>'-'<cm>'')<cm>'<cl>'<cm>''),>,'" + startdate.value.replaceAll("-", "").replaceAll(":", "") + "000000'")
        }
        if (enddate.value.replaceAll(" ", "") != ""){
            query_items.push("replace(replace(obs<cm>'-'<cm>'')<cm>'<cl>'<cm>''),<,'" + enddate.value.replaceAll("-", "").replaceAll(":", "") + "000000'")
        }

        //put everything else together
        query_items.push("COS(RADIANS(elev))*(end_az-start_az),>," + azwidth.value.replaceAll("-", "").replaceAll(":", ""))

        if (sourcesearch.checked){
            query_items.push("source,IS NOT,NULL")
        }

        for (var i = tbody.children.length - 1; i > 0; i--){
            queryresults.deleteRow(i)
        }

       
        if (maxhits.value * 1 > 2000){
            maxhits.value = 2000
        }
        var req = new XMLHttpRequest;

        var query = "/query/" + query_items.join(":")
        //for (var item of query_items){
        //    query = query + item
        //}

        
        query = query + "|"
        
        query = query + "exceed,DESC"

        query = query + "|"

        query = query + maxhits.value

        

        req.open("GET", query)
        req.send()
        req.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                console.log(this.responseText)
                var data = this.responseText.split("\n")
                data = data.filter(el => el != "")
                for (var ind = 0; ind < data.length; ind++){
                    //0 is obs
                    //1 is start az
                    //2 is end az
                    //3 is elevation
                    //4 is cfreq
                    //5 is exceed power
                    //6 is antlo
                    //7 is source guess
                    let entry = data[ind]
                    var spl = entry.split(",")
                    var row = document.createElement("tr")
                    
                    //first the rank
                    row.innerHTML += "<td>" + (ind + 1) + "</td>"
                    //now the obs name
                    row.innerHTML += "<td>" + spl[0] + "</td>"
                    //now the average azimuth
                    let avgaz = Math.round(100 * 0.5 * (spl[1] * 1 + spl[2] * 1)) / 100
                    row.innerHTML += "<td>" + avgaz + "</td>"
                    //now the elevation
                    row.innerHTML += "<td>" + spl[3] + "</td>"
                    //now the exceed value
                    row.innerHTML += "<td>" + spl[5] + "</td>"
                    //now the effective width
                    let azwidth = spl[2] - spl[1]
                    row.innerHTML += "<td>" + Math.round(100 * azwidth * Math.cos(spl[3] * Math.PI / 180)) / 100 + "</td>"

                    //now the CFREQ
                    row.innerHTML += "<td>" + spl[4] + "</td>"

                    //now the antlo
                    row.innerHTML += "<td>" + spl[6] + "</td>"

                    //now the source guess
                    if (spl[7] == "null" || spl[7] == null || spl[7].includes("null")){
                        spl[7] = "?"
                    }
                    row.innerHTML += "<td>" + spl[7] + "</td>"

                    //now the url
                    row.innerHTML += "<td><a href='/main?obs=" + spl[0] + "&freq=" + spl[4].replace(" ", "") + "' target='_blank'>View in portal --></a></td>"
                    //give the table row alternating background colors based on the observation
                    if (row.children[1].textContent != tbody.children[tbody.children.length - 1].children[1].textContent){
                        ROWCOLOR = getRowColor(ROWCOLOR)
                    }
                    /*var obs = spl[0];
                    var t = obs.split("-")
                    var t = t[t.length - 1].split(":")
                    var r = (t[0] * 1)
                    var g = (t[1] * 1)
                    var b = (t[2] * 1)
                    var c = (r + g + b) % Object.keys(COLORS).length*/
                    row.style.backgroundColor = ROWCOLOR//COLORS[c]

                    tbody.appendChild(row)
                }
            }
        }
    }

    document.onkeydown = function(e){
        if (e.keyCode == 13){
            //submitQuery()
        }
    }
</script>
</html>
