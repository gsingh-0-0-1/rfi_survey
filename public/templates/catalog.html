<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ATA RFI Catalog</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300&display=swap" rel="stylesheet">
    <style>
        body{
            font-family: Source Code Pro;
            background-color: #123;
            text-align: center;
        }
        
        .forminput{
            font-family: Source Code Pro;
            background-color: #345;
            border: none;
            color: white;
            padding: 1vh 1vh;
        }

        .forminput:focus{
            outline: none
        }

        .formbutton{
            position: relative;
            font-family: Source Code Pro;
            background-color: #666;
            border: none;
            color: #eee;
            padding: 1vh 1vh;
            margin-top: 1.5%;
        }
        
        .formbutton:focus{
            outline: none;
        }

        #queryresults{
            position: relative;
            margin-top: 5%;
            left: 2%;
            width: 96%;
            color: white;
            border: 0.1vh solid #888;
            table-layout: fixed;
        }

        a{
            color: #aaf
        }

        #queryresults{
            border-collapse: collapse;
            font-size: calc(1.1vh + 0.5vw);
            text-align: left;
        }

        #queryresults tr:nth-child(5n + 1){
            border-bottom: 0.1vh solid #888;
        }

        #queryresults tr td{
            border-right: 0.05vh solid #888;
            text-indent: 0.7vh;
        }

        #queryresults tr td:first-child{
            text-indent: 0px;
        }

        #queryresults tr td.field_rank{
            width: 5%;
            text-align: right;
            padding-right: 1%;
        }

        #queryresults tr td.field_obs{
            width: 15%;
        }

        #queryresults tr td.field_source{
            width: 20%;
        }

        #queryform{
            text-align: left;
            position: relative;
            left: 50%;
            transform: translate(-50%, 0%);
            color: white;
            border-collapse: collapse;
            border: 0.2vh solid white;
        }

        #queryform td{
            border-top: 0.05vh solid white;
            border-bottom: 0.05vh solid white;
        }
        #queryform td:nth-child(3n + 2){
            /*border: none;*/
        }

        #queryform td{
            padding: 1vh 1vh;
        }

        #queryform tr:nth-child(2n + 1){
            border-bottom: 0.2vh solid white;
        }

        #queryform td:nth-child(3n){
            border-right: 0.2vh solid white;
        }

        .catalog_table_title{
            width: 100%;
            text-align: center;
            font-size: 5vh;
        }

        .field_obs{
            color: #0ff;
        }

        .field_az{
            color: #09e;
            width: 6%;
        }

        .field_el{
            color: #09e;
            width: 5%;
        }

        .field_exceed{
            color: #fa0;
        }

        .field_eaw{
            color: #f22;
        }

        .field_cfreq{
            color: #ff2;
            width: 7%;
        }

        .field_ant{
            color: #888;
            width: 4%;
        }

        .field_source{
        
        }
        
        .field_url{
            width: 4%;
        }

        .bbottom{
            border-bottom: 0.1vh solid white;
        }
        
        .btop{
            border-top: 0.1vh solid white;
        }

        .bleft{
            border-left: 0.1vh solid white;
        }

        .bright{
            border-right: 0.1vh solid white;
        }
   
        #loading{
            position: relative;
            margin-top: 10%;
            color: #ddd;
            font-family: Source Code Pro, Courier;
            font-size: 5vh;
        }

        /*Checkboxes styles*/
        input[type="checkbox"] { display: none; }

        input[type="checkbox"] + label {
            display: block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 20px;
            color: #ddd;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        input[type="checkbox"] + label:last-child { margin-bottom: 0; }

        input[type="checkbox"] + label:before {
            content: '';
            display: block;
            width: 20px;
            height: 20px;
            border: 1px solid #6cc0e5;
            position: absolute;
            left: 0;
            top: 0;
            opacity: .6;
            -webkit-transition: all .12s, border-color .08s;
            transition: all .12s, border-color .08s;
        }

        input[type="checkbox"]:checked + label:before {
            width: 10px;
            top: -5px;
            left: 5px;
            border-radius: 0;
            opacity: 1;
            border-top-color: transparent;
            border-left-color: transparent;
            -webkit-transform: rotate(45deg);
			transform: rotate(45deg);
		}
    </style>
</head>
<body>

    <table id="queryform">
        <tbody>
            <tr>
                <td colspan="9" class="catalog_table_title">
                    ATA RFI Catalog
                </td>
            </tr>
            <tr>
                <td class='field_obs'>
                    Obs Name
                </td>
                <td>
                </td>
                <td>
                    <input type="checkbox" id="fetch_obs">
                    <label for="fetch_obs" style="color: #FFFFFF; display: inline"></label>
                </td>

                <!-- ************************************************************************* -->

                <td class='field_az'>
                    Azimuth
                </td>
                <td>
                </td>
                <td>
                    <input type="checkbox" id="fetch_az">
                    <label for="fetch_az" style="color: #FFFFFF; display: inline"></label>
                </td>

                <!-- ************************************************************************* -->

                <td class='field_el'>
                    Elevation
                </td>
                <td>
                </td>
                <td>
                    <input type="checkbox" id="fetch_el">
                    <label for="fetch_el" style="color: #FFFFFF; display: inline"></label>
                </td>
            </tr>
            <tr>
                <td>
                    <input class="forminput" type="text" id="obs_lo" placeholder="YYYY-MM-DD(-HH:MM:SS)">
                </td>
                <td>
                    ->
                </td>
                <td>
                    <input class="forminput" type="text" id="obs_hi" placeholder="YYYY-MM-DD(-HH:MM:SS)">
                </td>

                <!-- ************************************************************************* -->

                <td>
                    <input class="forminput" type="text" id="az_lo" placeholder="Degrees">
                </td>
                <td>
                    ->
                </td>
                <td>
                    <input class="forminput" type="text" id="az_hi" placeholder="Degrees">
                </td>

                <!-- ************************************************************************* -->

                <td>
                    <input class="forminput" type="text" id="el_lo" placeholder="Degrees">
                </td>
                <td>
                    ->
                </td>
                <td>
                    <input class="forminput" type="text" id="el_hi" placeholder="Degrees">
                </td>
            </tr>

            <tr>
                <td class='field_exceed'>
                    Power Spike
                </td>
                <td>
                </td>
                <td>
                    <input type="checkbox" id="fetch_exceed">
                    <label for="fetch_exceed" style="color: #FFFFFF; display: inline"></label>
                </td>

                <!-- ************************************************************************* -->

                <td class='field_eaw'>
                    Eff. Az. Width
                </td>
                <td>
                </td>
                <td>
                    <input type="checkbox" id="fetch_eaw">
                    <label for="fetch_eaw" style="color: #FFFFFF; display: inline"></label>
                </td>

                <!-- ************************************************************************* -->

                <td class='field_cfreq'>
                    CFREQ
                </td>
                <td>
                </td>
                <td>
                    <input type="checkbox" id="fetch_cfreq">
                    <label for="fetch_cfreq" style="color: #FFFFFF; display: inline"></label>
                </td>
            </tr>

            <tr>
                <td>
                    <input class="forminput" type="text" id="exceed_lo" placeholder="(dB)">
                </td>
                <td>
                    ->
                </td>
                <td>
                    <input class="forminput" type="text" id="exceed_hi" placeholder="(dB)">
                </td>

                <!-- ************************************************************************* -->

                <td>
                    <input class="forminput" type="text" id="eaw_lo" placeholder="Degrees">
                </td>
                <td>
                    ->
                </td>
                <td>
                    <input class="forminput" type="text" id="eaw_hi" placeholder="Degrees">
                </td>

                <!-- ************************************************************************* -->

                <td>
                    <input class="forminput" type="text" id="cfreq_lo" placeholder="MHz">
                </td>
                <td>
                    ->
                </td>
                <td>
                    <input class="forminput" type="text" id="cfreq_hi" placeholder="MHz">
                </td>
            </tr>

            <tr>
                <td class='field_ant'>
                    Antenna
                </td>
                <td>
                </td>
                <td>
                    <input type="checkbox" id="fetch_ant">
                    <label for="fetch_ant" style="color: #FFFFFF; display: inline"></label>
                </td>

                <!-- ************************************************************************* -->

                <td class='field_sat'>
                    Satellite Guess
                </td>
                <td>
                </td>
                <td>
                    <input type="checkbox" id="fetch_sat">
                    <label for="fetch_sat" style="color: #FFFFFF; display: inline"></label>
                </td>

                <!-- ************************************************************************* -->

                <td>
                    
                </td>
                <td>
                </td>
                <td>
                </td>
            </tr>

            <tr>
                <td>
                    <input class="forminput" type="text" id="ant_lo" placeholder="<ant1>,<ant2>,...">
                </td>
                <td>
                </td>
                <td>
                </td>

                <!-- ************************************************************************* -->

                <td>
                    <input class="forminput" type="text" id="sat_lo" placeholder="<guess1>,<guess2>,...">
                </td>
                <td>
                </td>
                <td>
                    <input type="checkbox" id="named_only">
                    <label for="named_only" style="color: #FFFFFF; display: inline">Named Sources</label>
                </td>

                <!-- ************************************************************************* -->

                <td>
                </td>
                <td>
                </td>
                <td>
                </td>
            </tr>            
        </tbody>
    </table>

    <input type="button" class='formbutton' value='ENTER to Search'>
    <input type="button" class='formbutton' value='SHIFT+S to Select All'>
    <input type="button" class='formbutton' value='SHIFT+ENTER to Raw Query' id='rawq'>

    <div id="loading">
    </div>

    <table id="queryresults">
        <tbody>
            <tr style='background-color: #123'>
            </tr>
        </tbody>
    </table>
</body>
<script>
    var tbody = queryresults.children[0];

    var COLORS = {0 : "#001020",
        1 : "#081828",
        2 : "#102030",
        3 : "#182838",
        4 : "#203040",
        5 : "#283848",
        6 : "#304050",
        7 : "#384858"
    }

    function searchFullSky(){
        //frange.value = 336
        az.value = 180
        azrange.value = 180
        el.value = 45
        elrange.value = 45
        submitQuery()
    }


    function getRowColor(c){
        if (c == "#012"){
            return "#152535"
        }
        return "#012"
    }

    function correctKey(key){
        var mod = key
        if (mod.includes("obs")){
            mod = "obs"
        }
        if (mod == "start_az"){
            mod = "az"
        }
        if (mod == "end_az"){
            return false
        }
        if (mod == "source_sat"){
            mod = "source"
        }
        if (mod == "antlo"){
            mod = "ant"
        }
        if (mod == 'elev'){
            mod = 'el'
        }
        return mod
    }

    function correctVal(val){
        if (val == "eaw"){
            val = "EFF. AZ. WIDTH"
        }
        if (val == "exceed"){
            val = "Power Spike (dB)"
        }
        if (val == 'source'){
            val = 'sat. source guess'
        }
        return val
    }

    function addColumn(key, content, url){
        var el = document.createElement("td")
        el.classList.add("field_" + key.toLowerCase())
        if (url){
            el.innerHTML = String(content)
        }
        else{
            el.textContent = String(content).toUpperCase()
        }
        tbody.rows[tbody.rows.length - 1].appendChild(el)
    }

    function proc(el){
        let val = el.value.replaceAll(" ", "")
        return val
    }

    function autoCheck(){
        if (named_only.checked){
            fetch_sat.checked = true
        }
        if (fetch_eaw.checked){
            fetch_az.checked = true
            fetch_el.checked = true
        }
    }

    var loadinginterval = 0;
    function animateLoading(){
        loading.innerHTML = loading.innerHTML.replace("...", "")
        loading.innerHTML = loading.innerHTML + "."
    }

    function showLoading(){
        loading.style.display = "block"
        loading.innerHTML = "Fetching data."
        loadinginterval = setInterval(animateLoading, 300)
    }

    function hideLoading(){
        loading.style.display = "none";
        clearInterval(loadinginterval)           
    }

    function submitQuery(raw = false){
        clearInterval(loadinginterval)
        autoCheck()
        var ROWCOLOR = "#012"

        var fetch_items = []

        //let's see what the user wants to fetch
        if (fetch_obs.checked){
            fetch_items.push("obs")
        }
        if (fetch_az.checked){
            fetch_items.push("start_az")
            fetch_items.push("end_az")
        }
        if (fetch_el.checked){
            fetch_items.push("elev")
        }
        if (fetch_exceed.checked){
            fetch_items.push("exceed")
        }
        if (fetch_cfreq.checked){
            fetch_items.push("cfreq")
        }
        if (fetch_ant.checked){
            fetch_items.push("antlo")
        }
        if (fetch_sat.checked){
            fetch_items.push("source_sat")
        }

        var query_items = []
        
        var obslo = ''
        var obshi = ''
        if (proc(obs_lo) != ""){
            obslo = proc(obs_lo).replaceAll(":", "").replaceAll("-", "")
            while (obslo.length < 14){
                obslo = obslo + "0"
            }
            obslo = "'" + obslo + "'"
        }

        if (proc(obs_hi) != ""){
            obshi = proc(obs_hi).replaceAll(":", "").replaceAll("-", "")
            while (obshi.length < 14){
                obshi = obshi + "0"
            }
            obshi = "'" + obshi + "'"
        }
        
        query_items.push(["obs", obslo, obshi].join(","))
        query_items.push(["az", proc(az_lo), proc(az_hi)].join(","))
        query_items.push(["el", proc(el_lo), proc(el_hi)].join(","))
        query_items.push(["exceed", proc(exceed_lo), proc(exceed_hi)].join(","))
        query_items.push(["eaw", proc(eaw_lo), proc(eaw_hi)].join(","))
        query_items.push(["cfreq", proc(cfreq_lo), proc(cfreq_hi)].join(","))
        query_items.push(["ant", proc(ant_lo)].join(","))
        query_items.push(["sat", proc(sat_lo)].join(","))

        if (named_only.checked){
            query_items.push(["sat", "NOTNULL"])
        }


        while (queryresults.rows.length > 0){
            queryresults.deleteRow(0)
        }

        var el = document.createElement("tr")
        tbody.appendChild(el)
        /*if (maxhits.value * 1 > 2000){
            maxhits.value = 2000
        }*/
        var req = new XMLHttpRequest;

        var query = "/query/" + fetch_items.join(",") + "|" + query_items.join(":")
        
        query = query + "|"
        
        query = query + "exceed,DESC"

        query = query + "|"

        query = query + "100"//maxhits.value

        console.log(query) 

        if (raw){
            window.open(query, "_blank")
        }

        req.open("GET", query)
        req.send()
        req.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                var data = JSON.parse(this.responseText)
                console.log(data)
                var keys = Object.keys(data[0])
                console.log(keys)
                if (fetch_eaw.checked){
                    keys.splice(keys.indexOf("elev") + 1, 0, "eaw")
                }
                if (keys.includes("cfreq") && keys.includes("obs")){
                    keys.push("url")
                }
                addColumn("RANK", "RANK")
                for (var key of keys){
                    let mod = correctKey(key)
                    if (!mod){
                        continue
                    }
                    var val = correctVal(mod)
                    addColumn(mod, val)

                }


                console.log(keys) 
                for (var ind = 0; ind < data.length; ind++){
                    var row = data[ind]
                    tbody.insertRow()
                    addColumn("RANK", tbody.rows.length - 1)
                    for (var key of keys){
                        let val = row[key]
                        if (val == "NULL" || val == "null" || val == null){
                            val = "?"
                        }
                        let mod = correctKey(key)
                        let url = false
                        if (!mod){
                            continue
                        }
                        if (mod == 'az'){
                            val = Math.round(0.5 * (row['start_az'] + row['end_az']) * 100) / 100
                        }
                        if (mod == 'eaw'){
                            val = Math.round(Math.cos(Math.PI * row['elev'] / 180) * (row['end_az'] - row['start_az']) * 100) / 100
                        }
                        if (mod == 'url'){
                            url = true
                            val = "<a target='_blank' href='/scanobs/" + row['obs'] + "/heatmaps/?freq=" + row['cfreq'] + "'>--></a>"
                        }
                        addColumn(mod, val, url)
                    }
                    if (keys.includes('obs')){
                        if (ind == 0){
                        }
                        else if (row['obs'] != data[ind - 1]['obs']){
                            ROWCOLOR = getRowColor(ROWCOLOR)
                        }
                        tbody.rows[tbody.rows.length - 1].style.backgroundColor = ROWCOLOR
                    }
                }
                hideLoading()
            }
        }
    }

    function selectAll(){
        for (var el of document.querySelectorAll("input[type=checkbox]")){
            el.checked = true
        }
    }

    document.onkeydown = function(e){
        if (e.code == "Enter" && !e.shiftKey){
            submitQuery()
        }
        if (e.shiftKey && e.code == "KeyS"){
            selectAll()
        }
        if (e.code == "Enter" && e.shiftKey){
            submitQuery(true)
        }
    }

    for (var el of document.querySelectorAll("input[type=checkbox]")){
        el.onchange = autoCheck
    }

    var params = window.location.href.split("?")
    console.log(params)
    if (params.length > 1){
        params = params[1]
        params = params.split("&")
        for (var param of params){
            let spl = param.split("=")
            let key = spl[0]
            let lo = spl[1].split(",")[0]
            let hi = spl[1].split(",")[1]
            if (isNaN(hi)){
                document.getElementById(key + "_lo").value = lo
            }
            else{
                document.getElementById(key + "_lo").value = lo
                document.getElementById(key + "_hi").value = hi
            }
        }
        selectAll()
        named_only.checked = false
        submitQuery()
    }

</script>
</html>
